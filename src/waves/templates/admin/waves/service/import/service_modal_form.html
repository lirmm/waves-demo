{% load crispy_forms_tags %}
<div id="form_modal_container">
    <div id="spinner-container" class="">
        <div id="spinner" class="spinner" style="display: none">
            <img id="img-spinner" src="/static/waves/img/ajax-loader.gif" alt="Loading"/>
        </div>
    </div>
    <div id="form-modal">
        {% if messages %}
            <ul id="form-message" class="messages grp-messagelist">
                {% for message in messages %}
                    <li class="alert {% if message.tags %}alert-{{ message.tags }} grp-{{ message.tags }}{% endif %}">
                        {{ message }}
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
        {% if form %}
            <div id="form_import_content" style="z-index: 5" align="center">
                <form class="form-horizontal" id="form_import" method="post"
                      action="{% url 'waves:service_import_form' service_id %}">
                    {% crispy form %}
                </form>
            </div>

            <script type="text/javascript">
                (function ($) {
                    $('#launch-import').click(function (e) {
                        e.defaultPrevented;
                        $.ajax({
                            type: $("#form_import").attr('method'),
                            url: $("#form_import").attr('action'),
                            data: $("#form_import").serialize(),
                            // dataType: 'json',
                            beforeSend: function () {
                                $('#launch-import').attr('disabled', 'disabled');
                                $('#id_tool_list').attr('disabled', 'disabled');
                                $('#spinner').css('display', 'block');
                            },
                        }).complete(function () {
                            $('#launch-import').removeAttr('disabled');
                            $('#id_tool_list').removeAttr('disabled');
                            $('#spinner').css('display', 'none');
                        }).done(function (data) {
                            window.location.replace(data.url_redirect);
                            $('#form-modal').modal('toggle');
                        }).fail(function (xhr, thrownError) {
                            // handle response errors here
                            console.log('errors ' + JSON.stringify(xhr));
                            $('#form_import').replaceWith(xhr.responseJSON['form_html'])
                            $('.alert.alert-block.alert-danger > ul').addClass('grp-messagelist');
                            $('.alert.alert-block.alert-danger > ul > li').addClass('grp-error');
                            $('.help-block').css('display', 'none');
                        }).always(function (data) {
                            // console.log('always call ' + JSON.stringify(data));
                        });
                        return false;
                    });
                })(jQuery || django.jQuery)
            </script>
        {% endif %}
    </div>
</div>